name: üöÄ Build Launcher

on:
  push:
    branches: [main]
    paths:
      - 'launcher/**'
      - '.github/workflows/launcher.yml'
  workflow_dispatch:

env:
  VERSION: "2.0.${{ github.run_number }}"

jobs:
  build-launcher:
    name: üöÄ Build GUI Launcher
    runs-on: windows-latest

    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: üîß Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: ‚ö° Setup Ninja
      uses: seanmiddleditch/gha-setup-ninja@v5

    - name: üì¶ Download ImGui
      working-directory: launcher
      run: |
        Write-Host "Downloading ImGui..."
        
        # Create imgui directory
        New-Item -ItemType Directory -Force -Path "imgui" | Out-Null
        
        # Download ImGui files
        $imgui_version = "v1.90.1"
        $imgui_base = "https://raw.githubusercontent.com/ocornut/imgui/$imgui_version"
        
        $files = @(
          "imgui.h", "imgui.cpp", "imgui_draw.cpp", "imgui_tables.cpp", "imgui_widgets.cpp",
          "imgui_internal.h", "imstb_rectpack.h", "imstb_textedit.h", "imstb_truetype.h",
          "backends/imgui_impl_win32.h", "backends/imgui_impl_win32.cpp",
          "backends/imgui_impl_dx11.h", "backends/imgui_impl_dx11.cpp"
        )
        
        foreach ($file in $files) {
          $fileName = Split-Path $file -Leaf
          Write-Host "  Downloading $fileName..."
          Invoke-WebRequest -Uri "$imgui_base/$file" -OutFile "imgui/$fileName"
        }
        
        Write-Host "‚úÖ ImGui downloaded"

    - name: ‚öôÔ∏è Configure
      working-directory: launcher
      run: |
        Write-Host ""
        Write-Host "=========================================="
        Write-Host "   CS-LEGIT LAUNCHER v${{ env.VERSION }}"
        Write-Host "=========================================="
        
        cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DLAUNCHER_VERSION="${{ env.VERSION }}"

    - name: üî® Build
      working-directory: launcher
      run: cmake --build build --config Release

    - name: ‚úÖ Verify Build
      working-directory: launcher
      run: |
        Write-Host ""
        Write-Host "=========================================="
        Write-Host "   BUILD SUCCESS"
        Write-Host "=========================================="
        
        Get-ChildItem -Path build -Recurse -Include *.exe | ForEach-Object {
          $size = [math]::Round($_.Length / 1KB, 2)
          Write-Host "   $($_.Name): $size KB"
        }

    - name: üì§ Upload to Server
      if: success() && github.ref == 'refs/heads/main'
      working-directory: launcher
      env:
        SERVER_URL: ${{ secrets.SERVER_URL }}
        CI_API_KEY: ${{ secrets.CI_API_KEY }}
      run: |
        if ([string]::IsNullOrEmpty($env:SERVER_URL)) {
          Write-Host "‚ö†Ô∏è SERVER_URL not set, skipping upload"
          exit 0
        }
        
        Write-Host "Uploading to server..."
        
        # Find launcher.exe specifically (not CMake test files)
        $exe = Get-ChildItem -Path build -Recurse -Include "launcher.exe" | Select-Object -First 1
        
        if ($exe) {
          Write-Host "Found: $($exe.FullName)"
          curl.exe -X POST "$env:SERVER_URL/api/admin/ci/upload" `
            -H "X-CI-API-Key: $env:CI_API_KEY" `
            -F "game_id=launcher" `
            -F "file_type=launcher" `
            -F "version=${{ env.VERSION }}" `
            -F "file=@$($exe.FullName)"
            
          Write-Host "‚úÖ Uploaded to server!"
        } else {
          Write-Host "‚ö†Ô∏è launcher.exe not found!"
          Get-ChildItem -Path build -Recurse -Include *.exe | ForEach-Object { Write-Host "  Found: $($_.Name)" }
        }

    - name: üì¶ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: CS-Legit-Launcher-v${{ env.VERSION }}
        path: launcher/build/*.exe
        retention-days: 30
