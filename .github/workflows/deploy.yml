name: Build & Deploy to Server

on:
  push:
    branches: [main]
    paths:
      - 'hypervisor-cheat/**'
      - 'kernel/**'
  workflow_dispatch:
    inputs:
      game:
        description: 'Game to build (cs2, dayz, all)'
        required: true
        default: 'all'

env:
  SERVER_URL: ${{ secrets.LAUNCHER_SERVER_URL }}
  CI_API_KEY: ${{ secrets.CI_API_KEY }}

jobs:
  # ============================================
  # Build CS2 Internal Cheat
  # ============================================
  build-cs2-internal:
    name: Build CS2 Internal
    runs-on: windows-latest
    if: github.event.inputs.game == 'cs2' || github.event.inputs.game == 'all' || github.event.inputs.game == ''
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2
        
      - name: Download ImGui
        run: |
          git clone --depth 1 https://github.com/ocornut/imgui.git external/imgui
          
      - name: Configure CMake
        run: |
          cd hypervisor-cheat/internal
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          
      - name: Build
        run: |
          cd hypervisor-cheat/internal/build
          cmake --build . --config Release
          
      - name: Upload to Server
        if: success() && env.SERVER_URL != ''
        shell: bash
        run: |
          # Find the DLL
          DLL_PATH=$(find hypervisor-cheat/internal/build -name "*.dll" -type f | head -1)
          
          if [ -z "$DLL_PATH" ]; then
            echo "No DLL found!"
            exit 1
          fi
          
          echo "Uploading $DLL_PATH to server..."
          
          # Get version from date
          VERSION=$(date +%Y.%m.%d)
          
          curl -X POST "$SERVER_URL/api/admin/ci/upload" \
            -H "X-CI-API-KEY: $CI_API_KEY" \
            -F "game_id=cs2" \
            -F "version=$VERSION" \
            -F "changelog=Build from commit ${{ github.sha }}" \
            -F "commit_sha=${{ github.sha }}" \
            -F "file=@$DLL_PATH"
            
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cs2-internal
          path: hypervisor-cheat/internal/build/**/*.dll

  # ============================================
  # Build CS2 Overlay (External)
  # ============================================
  build-cs2-overlay:
    name: Build CS2 Overlay
    runs-on: windows-latest
    if: github.event.inputs.game == 'cs2' || github.event.inputs.game == 'all' || github.event.inputs.game == ''
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2
        
      - name: Configure CMake
        run: |
          cd hypervisor-cheat
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          
      - name: Build
        run: |
          cd hypervisor-cheat/build
          cmake --build . --config Release
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cs2-overlay
          path: hypervisor-cheat/build/**/*.exe

  # ============================================
  # Update Offsets
  # ============================================
  update-offsets:
    name: Update CS2 Offsets
    runs-on: ubuntu-latest
    if: github.event.inputs.game == 'cs2' || github.event.inputs.game == 'all' || github.event.inputs.game == ''
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Fetch Latest Offsets
        run: |
          # Download latest offsets from cs2-dumper
          curl -s https://raw.githubusercontent.com/a2x/cs2-dumper/main/output/offsets.json -o offsets_raw.json
          curl -s https://raw.githubusercontent.com/a2x/cs2-dumper/main/output/client_dll.json -o client_dll.json
          
          # Create formatted offsets
          cat > cs2_offsets.json << 'EOF'
          {
            "game": "cs2",
            "version": "$(date +%Y-%m-%d)",
            "source": "cs2-dumper",
            "client_dll": {},
            "entity": {},
            "controller": {},
            "scene": {},
            "player": {}
          }
          EOF
          
      - name: Upload Offsets to Server
        if: env.SERVER_URL != ''
        run: |
          curl -X POST "$SERVER_URL/api/admin/ci/offsets/cs2" \
            -H "X-CI-API-KEY: $CI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @cs2_offsets.json || echo "Server not configured"

  # ============================================
  # Notify on Completion
  # ============================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [build-cs2-internal, build-cs2-overlay]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CS2 Internal | ${{ needs.build-cs2-internal.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CS2 Overlay | ${{ needs.build-cs2-overlay.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

