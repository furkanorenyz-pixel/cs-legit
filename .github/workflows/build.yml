name: üîì Build External

on:
  push:
    branches: [main]
    paths:
      - 'externa/**'
      - '.github/workflows/build.yml'
  workflow_dispatch:

env:
  VERSION: "1.0.${{ github.run_number }}"

jobs:
  build-external:
    name: üîì EXTERNAL (Overlay ESP)
    runs-on: windows-latest
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: üîß Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
      
      - name: ‚ö° Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v5
      
      - name: üíæ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: externa/build/_deps
          key: ${{ runner.os }}-external-${{ hashFiles('externa/CMakeLists.txt') }}
          restore-keys: ${{ runner.os }}-external-
      
      - name: ‚öôÔ∏è Configure
        working-directory: externa
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "   EXTERNAL ESP v${{ env.VERSION }}"
          Write-Host "=========================================="
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
      
      - name: üî® Build
        working-directory: externa
        run: cmake --build build --config Release --parallel
      
      - name: ‚úÖ Verify
        working-directory: externa
        run: |
          $exe = Get-ChildItem -Path build -Filter "*.exe" | Select-Object -First 1
          if ($exe) {
            $size = [math]::Round($exe.Length / 1KB, 2)
            Write-Host ""
            Write-Host "=========================================="
            Write-Host "   BUILD SUCCESS"
            Write-Host "   File: $($exe.Name)"
            Write-Host "   Size: $size KB"
            Write-Host "=========================================="
          } else {
            Write-Error "Build failed!"
            exit 1
          }

      - name: üì§ Upload to Server
        if: success() && github.ref == 'refs/heads/main'
        working-directory: externa
        env:
          SERVER_URL: ${{ secrets.SERVER_URL }}
          CI_API_KEY: ${{ secrets.CI_API_KEY }}
        run: |
          Write-Host "Uploading to server..."
          
          $exe = Get-ChildItem -Path build -Filter "*.exe" | Select-Object -First 1
          
          if ($exe) {
            # Create version info
            $versionJson = @{
              version = "${{ env.VERSION }}"
              build = ${{ github.run_number }}
              commit = "${{ github.sha }}"
              date = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
            } | ConvertTo-Json
            
            $versionJson | Out-File -FilePath "build/version.json" -Encoding UTF8
            
            curl.exe -X POST "$env:SERVER_URL/api/admin/ci/upload" `
              -H "X-CI-API-Key: $env:CI_API_KEY" `
              -F "game_id=cs2" `
              -F "file_type=externa" `
              -F "version=${{ env.VERSION }}" `
              -F "file=@$($exe.FullName)"
              
            Write-Host "‚úÖ Uploaded to server!"
          } else {
            Write-Host "‚ùå No exe found"
            exit 1
          }
      
      - name: üì¶ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: External-v${{ env.VERSION }}
          path: |
            externa/build/*.exe
            externa/build/version.json
          retention-days: 30
