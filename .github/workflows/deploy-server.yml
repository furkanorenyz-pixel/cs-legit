name: üöÄ Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'launcher-server/**'
      - '.github/workflows/deploy-server.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: üîÑ Deploy Server Updates
    runs-on: ubuntu-latest
    
    steps:
      - name: üì° Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "=== Starting deployment ==="
            cd ~/cs-legit
            
            echo "=== Git pull ==="
            git pull origin main
            
            echo "=== Installing dependencies ==="
            cd launcher-server/backend
            npm install --production
            
            echo "=== Restarting service ==="
            systemctl restart launcher
            
            echo "=== Waiting for service to start ==="
            sleep 5
            
            echo "=== Checking service status ==="
            systemctl status launcher --no-pager || true
            
            echo "=== Deployment complete ==="
      
      - name: üîç Verify Server Health
        env:
          SERVER_URL: ${{ secrets.SERVER_URL }}
        run: |
          echo "Waiting 5 more seconds for full startup..."
          sleep 5
          
          echo "Checking server health..."
          RESPONSE=$(curl -s "$SERVER_URL/health" || echo "failed")
          echo "Health check response: $RESPONSE"
          
          if echo "$RESPONSE" | grep -q '"status":"ok"'; then
            echo "‚úÖ Server is healthy and ready"
          else
            echo "‚ö†Ô∏è Server may need more time to start"
            echo "Check logs: journalctl -u launcher -n 50"
          fi

